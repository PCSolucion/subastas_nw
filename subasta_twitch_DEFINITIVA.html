<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Subastas - Liiukiin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #9147ff;
            --primary-dark: #772ce8;
            --secondary: #18181b;
            --bg-dark: #0e0e10;
            --bg-card: #1f1f23;
            --text: #efeff1;
            --text-muted: #adadb8;
            --success: #00c853;
            --warning: #ff9800;
            --danger: #ff4444;
            --border: #2c2c35;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--secondary);
            padding: 1.5rem 2rem;
            border-bottom: 2px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            background: var(--bg-card);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
        }

        /* Active Auction */
        .active-auction {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: 2px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        .active-auction::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--primary), var(--danger), var(--primary));
            z-index: -1;
            animation: border-animation 3s linear infinite;
            border-radius: 8px;
        }

        @keyframes border-animation {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .auction-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--danger);
            color: white;
            padding: 0.375rem 0.875rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 10;
        }

        .auction-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-right: 6rem;
        }

        /* Auction Images Gallery */
        .auction-images {
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
        }

        .auction-main-image {
            width: 100%;
            max-height: 159px;
            object-fit: contain;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            display: block;
        }

        .auction-thumbnails {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            overflow-x: auto;
            padding: 0.25rem 0;
        }

        .auction-thumbnails::-webkit-scrollbar {
            height: 6px;
        }

        .auction-thumbnails::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .auction-thumbnails::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .thumbnail {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .thumbnail:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .thumbnail.active {
            border-color: #ffeb3b;
        }

        .auction-timer {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-family: 'Courier New', monospace;
            color: #ffeb3b;
        }

        .auction-timer.warning {
            color: var(--warning);
            animation: timer-warning 1s infinite;
        }

        @keyframes timer-warning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .current-bid {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .bid-amount {
            font-size: 3rem;
            font-weight: 800;
            color: #ffeb3b;
            text-shadow: 0 2px 10px rgba(255, 235, 59, 0.3);
        }

        .bid-label {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .bid-winner {
            text-align: center;
            font-size: 1.25rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .winner-name {
            font-weight: 700;
            color: #ffeb3b;
        }

        .auction-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .auction-actions .btn {
            flex: 1;
        }

        /* Activity Log - LOGS ARRIBA */
        .activity-log {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
        }

        .log-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column; /* CAMBIADO: ya no es column-reverse */
        }

        .log-content::-webkit-scrollbar {
            width: 8px;
        }

        .log-content::-webkit-scrollbar-track {
            background: var(--secondary);
        }

        .log-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .log-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .log-entry {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            background: var(--secondary);
            border-left: 3px solid var(--border);
            font-size: 0.875rem;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px); /* CAMBIADO: ahora viene desde arriba */
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .log-entry.bid {
            border-left-color: var(--primary);
        }

        .log-entry.system {
            border-left-color: var(--text-muted);
        }

        .log-entry.winner {
            border-left-color: var(--success);
            background: rgba(0, 200, 83, 0.1);
        }

        .log-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        .log-user {
            color: var(--primary);
            font-weight: 600;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background: var(--secondary);
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        /* Config Section */
        .config-group {
            margin-bottom: 1.5rem;
        }

        .config-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        input[type="number"],
        input[type="text"],
        textarea {
            width: 100%;
            padding: 0.625rem;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.875rem;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* History */
        .history-item {
            background: var(--secondary);
            padding: 1.25rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--primary);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .history-title {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--text);
        }

        .history-amount {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary);
        }

        .history-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .history-detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text);
            margin-top: 0.25rem;
        }

        .history-winner {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .history-winner strong {
            color: var(--success);
        }

        /* User Stats Card */
        .user-stats-card {
            background: var(--secondary);
            padding: 1.25rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--success);
        }

        .user-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .user-stats-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success);
        }

        .user-stats-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .user-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
        }

        /* Leaderboard Table */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .leaderboard-table thead {
            background: var(--secondary);
        }

        .leaderboard-table th {
            padding: 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }

        .leaderboard-table td {
            padding: 0.875rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .leaderboard-table tbody tr:hover {
            background: var(--secondary);
        }

        .leaderboard-rank {
            font-weight: 700;
            color: var(--primary);
            width: 60px;
        }

        .leaderboard-rank.gold {
            color: #ffd700;
        }

        .leaderboard-rank.silver {
            color: #c0c0c0;
        }

        .leaderboard-rank.bronze {
            color: #cd7f32;
        }

        .leaderboard-username {
            font-weight: 600;
            color: var(--text);
        }

        .leaderboard-value {
            font-weight: 700;
            color: var(--primary);
            text-align: right;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--secondary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .image-preview {
            position: relative;
            aspect-ratio: 1;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid var(--border);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Auction Cards in Config */
        .auction-card {
            background: var(--secondary);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .auction-info h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .auction-info p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .auction-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--secondary);
            border-left: 1px solid var(--border);
            z-index: 2500;
            transition: right 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .debug-panel.active {
            right: 0;
        }

        .debug-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .debug-entry {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--bg-dark);
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Sistema de Subastas - Liiukiin</h1>
        <div class="header-actions">
            <div class="connection-status" id="connectionStatus">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Desconectado</span>
            </div>
            <button class="btn btn-secondary btn-sm" id="connectBtn" onclick="connectToTwitch()">Conectar</button>
            <button class="btn btn-secondary btn-sm" onclick="toggleDebugPanel()">Debug</button>
            <button class="btn btn-secondary btn-sm" onclick="exportStats()">Exportar</button>
            <button class="btn btn-primary" onclick="openNewAuctionModal()">Nueva Subasta</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-container">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Active Auction -->
            <div class="card active-auction" id="activeAuctionCard" style="display: none;">
                <span class="auction-badge">En Vivo</span>
                <h2 class="auction-title" id="activeAuctionTitle">Título de la Subasta</h2>

                <!-- GALERÍA DE IMÁGENES -->
                <div class="auction-images" id="auctionImages" style="display: none;">
                    <img src="" alt="Premio de subasta" class="auction-main-image" id="mainImage">
                    <div class="auction-thumbnails" id="thumbnailsContainer"></div>
                </div>

                <div class="auction-timer" id="auctionTimer">00:00</div>

                <div class="current-bid">
                    <div class="bid-label">Puja Actual</div>
                    <div class="bid-amount" id="currentBidAmount">0 ₧</div>
                </div>

                <div class="bid-winner">
                    <span class="bid-label">Ganador Actual:</span>
                    <span class="winner-name" id="currentWinner">Esperando pujas...</span>
                </div>

                <div class="auction-actions">
                    <button class="btn btn-danger" onclick="endAuction()">Finalizar</button>
                    <button class="btn btn-secondary" onclick="extendAuction()">+1 Min</button>
                </div>
            </div>

            <!-- No Active Auction State -->
            <div class="card" id="noAuctionCard">
                <div class="empty-state">
                    <div class="empty-state-icon">🎪</div>
                    <h3>No hay subastas activas</h3>
                    <p style="margin: 0.5rem 0 1.5rem;">Inicia una nueva subasta para comenzar</p>
                    <button class="btn btn-primary" onclick="openNewAuctionModal()">Crear Subasta</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Estadísticas Globales</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalAuctions">0</div>
                        <div class="stat-label">Subastas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalBids">0</div>
                        <div class="stat-label">Pujas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalPesetas">0 ₧</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgBid">0</div>
                        <div class="stat-label">Puja Media</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="uniqueBidders">0</div>
                        <div class="stat-label">Pujadores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="topBidder">-</div>
                        <div class="stat-label">Top Pujador</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="card">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'history')">Historial</button>
                    <button class="tab" onclick="switchTab(event, 'configured')">Subastas Configuradas</button>
                    <button class="tab" onclick="switchTab(event, 'leaderboards')">Tabla de Líderes</button>
                    <button class="tab" onclick="switchTab(event, 'users')">Usuarios</button>
                    <button class="tab" onclick="switchTab(event, 'config')">Configuración</button>
                </div>

                <!-- History Tab -->
                <div class="tab-content active" id="historyTab">
                    <div id="historyList"></div>
                    <div class="empty-state" id="emptyHistory">
                        <div class="empty-state-icon">📜</div>
                        <p>No hay subastas completadas</p>
                    </div>
                </div>

                <!-- Configured Auctions Tab -->
                <div class="tab-content" id="configuredTab">
                    <div id="configuredAuctionsList"></div>
                    <div class="empty-state" id="emptyConfigured">
                        <div class="empty-state-icon">🎁</div>
                        <p>No hay subastas configuradas</p>
                    </div>
                </div>

                <!-- Leaderboards Tab -->
                <div class="tab-content" id="leaderboardsTab">
                    <div class="card-header" style="border-bottom: none; padding: 0 0 1rem 0;">
                        <h3 class="card-title">Más Pujas Ganadas</h3>
                    </div>
                    <table class="leaderboard-table" id="winsLeaderboard">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usuario</th>
                                <th style="text-align: right;">Ganadas</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="card-header" style="border-bottom: none; padding: 2rem 0 1rem 0;">
                        <h3 class="card-title">Más Pesetas Gastadas</h3>
                    </div>
                    <table class="leaderboard-table" id="spentLeaderboard">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usuario</th>
                                <th style="text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="card-header" style="border-bottom: none; padding: 2rem 0 1rem 0;">
                        <h3 class="card-title">Más Pujas Participadas</h3>
                    </div>
                    <table class="leaderboard-table" id="participationLeaderboard">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usuario</th>
                                <th style="text-align: right;">Participación</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="empty-state" id="emptyLeaderboards" style="display: none;">
                        <div class="empty-state-icon">🏆</div>
                        <p>No hay datos de usuarios aún</p>
                    </div>
                </div>

                <!-- Users Tab -->
                <div class="tab-content" id="usersTab">
                    <div id="userStatsList"></div>
                    <div class="empty-state" id="emptyUsers">
                        <div class="empty-state-icon">👥</div>
                        <p>No hay usuarios registrados</p>
                    </div>
                </div>

                <!-- Config Tab -->
                <div class="tab-content" id="configTab">
                    <div class="config-group">
                        <label class="config-label">Restricciones de Participación</label>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="followersOnly">
                            <label for="followersOnly">Solo seguidores del canal</label>
                        </div>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="subscribersOnly">
                            <label for="subscribersOnly">Solo suscriptores</label>
                        </div>
                    </div>

                    <div class="config-group">
                        <label class="config-label" for="minMessages">Mensajes mínimos en el chat</label>
                        <input type="number" id="minMessages" min="0" value="0">
                    </div>

                    <div class="config-group">
                        <label class="config-label" for="maxBid">Puja máxima permitida (Pesetas)</label>
                        <input type="number" id="maxBid" min="0" value="0" placeholder="0 = sin límite">
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar: Activity Log -->
        <aside class="sidebar">
            <div class="activity-log">
                <div class="log-header">
                    <h3 class="card-title">Actividad en Vivo</h3>
                    <button class="btn-secondary btn-sm" onclick="clearLog()">Limpiar</button>
                </div>
                <div class="log-content" id="activityLog">
                    <div class="log-entry system">
                        <span class="log-time">[--:--]</span>
                        Sistema iniciado. Esperando conexión...
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- New Auction Modal -->
    <div class="modal" id="newAuctionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nueva Subasta</h3>
                <button class="modal-close" onclick="closeNewAuctionModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="newAuctionForm">
                    <div class="form-group">
                        <label class="form-label" for="auctionTitle">Título</label>
                        <input type="text" id="auctionTitle" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="auctionDescription">Descripción</label>
                        <textarea id="auctionDescription" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="startingPrice">Precio Inicial (Pesetas)</label>
                        <input type="number" id="startingPrice" min="1" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="auctionImages">Imágenes del Premio</label>
                        <input type="file" id="auctionImagesInput" multiple accept="image/*" onchange="previewImages()">
                        <div class="image-preview-grid" id="imagePreviewGrid"></div>
                    </div>

                    <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeNewAuctionModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Guardar Subasta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal" id="userDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="userDetailsTitle">Detalles del Usuario</h3>
                <button class="modal-close" onclick="closeUserDetailsModal()">×</button>
            </div>
            <div class="modal-body" id="userDetailsBody">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div class="debug-header">
            <h3>Panel de Debug</h3>
            <button class="modal-close" onclick="toggleDebugPanel()">×</button>
        </div>
        <div class="debug-content" id="debugContent">
            <div class="debug-entry">[Sistema] Debug iniciado</div>
        </div>
    </div>

    <script>
        // Variables globales
        let ws = null;
        let isConnected = false;
        let currentAuction = null;
        let timerInterval = null;
        let configuredAuctions = [];
        let auctionHistory = [];
        let allBids = {};
        let chatUsers = {};
        let userStats = {}; // NUEVO: Estadísticas por usuario
        let restrictions = {
            followersOnly: false,
            subscribersOnly: false,
            minMessages: 0,
            maxBid: 0
        };
        let globalStats = {
            totalAuctions: 0,
            totalBids: 0,
            totalPesetas: 0,
            uniqueBidders: new Set(),
            topBidder: null,
            topBidderAmount: 0
        };

        const DEFAULT_CHANNEL = 'liiukiin';
        const AUCTION_DURATION = 300000; // 5 minutos en ms

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
            loadAuctionHistory();
            loadConfiguredAuctions();
            loadUserStats();
            updateStats();
            renderLeaderboards();
            renderUserStats();

            // Form submission
            document.getElementById('newAuctionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewAuction();
            });

            // Auto-conectar a Twitch
            setTimeout(() => connectToTwitchAuto(), 1000);
        });

        // WebSocket Connection
        function connectToTwitch() {
            if (isConnected) {
                if (ws) ws.close();
                isConnected = false;
                updateConnectionStatus(false);
                addLog('Desconectado manualmente', 'system');
                return;
            }

            const channel = prompt('Ingresa el nombre del canal de Twitch:', DEFAULT_CHANNEL);
            if (!channel) return;

            connectToTwitchAuto(channel);
        }

        function connectToTwitchAuto(channel = DEFAULT_CHANNEL) {
            if (isConnected && ws) {
                addLog(`Ya conectado a ${channel}`, 'info');
                return;
            }

            try {
                ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

                ws.onopen = () => {
                    ws.send('CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership');
                    ws.send('PASS oauth:justinfan12345');
                    ws.send('NICK justinfan12345');
                    ws.send(`JOIN #${channel.toLowerCase()}`);
                    addLog(`Conectando al canal ${channel}...`, 'info');
                    debugLog(`Conectando a #${channel.toLowerCase()}`);
                };

                ws.onmessage = (event) => {
                    handleIRCMessage(event.data);
                };

                ws.onclose = () => {
                    isConnected = false;
                    updateConnectionStatus(false);
                    addLog('Desconectado de Twitch', 'error');
                    debugLog('Conexión cerrada');
                };

                ws.onerror = (error) => {
                    addLog('Error de conexión', 'error');
                    debugLog(`Error: ${error}`);
                    console.error('WebSocket error:', error);
                };
            } catch (error) {
                addLog('Error al conectar', 'error');
                debugLog(`Error al crear conexión: ${error}`);
                console.error('Connection error:', error);
            }
        }

        function handleIRCMessage(rawMessage) {
            debugLog(`IRC: ${rawMessage.substring(0, 100)}`);

            if (rawMessage.includes('PING')) {
                ws.send('PONG :tmi.twitch.tv');
                debugLog('PONG enviado');
                return;
            }

            if (rawMessage.includes('Welcome, GLHF!') || rawMessage.includes('001')) {
                isConnected = true;
                updateConnectionStatus(true);
                addLog(`Conectado exitosamente a ${DEFAULT_CHANNEL}`, 'success');
                debugLog('Conexión establecida correctamente');
            }

            if (rawMessage.includes('PRIVMSG')) {
                parsePrivMsg(rawMessage);
            }
        }

        function parsePrivMsg(rawMessage) {
            try {
                debugLog(`Parseando: ${rawMessage}`);

                let username = null;
                const userPatterns = [
                    /:(.+?)!/,
                    /display-name=([^;]+)/i,
                ];

                for (const pattern of userPatterns) {
                    const match = rawMessage.match(pattern);
                    if (match && match[1]) {
                        username = match[1];
                        break;
                    }
                }

                let message = null;
                const messagePatterns = [
                    /PRIVMSG #[^ ]+ :(.+)/,
                    /PRIVMSG #[^ ]+ (.+)/
                ];

                for (const pattern of messagePatterns) {
                    const match = rawMessage.match(pattern);
                    if (match && match[1]) {
                        message = match[1].trim();
                        break;
                    }
                }

                if (!username || !message) {
                    debugLog('No se pudo extraer usuario o mensaje');
                    return;
                }

                debugLog(`Usuario: ${username}, Mensaje: ${message}`);

                const badgesMatch = rawMessage.match(/badges=([^;]+)/);
                const badges = badgesMatch ? badgesMatch[1].split(',').map(b => b.split('/')[0]) : [];
                debugLog(`Badges: ${badges.join(', ') || 'ninguno'}`);

                if (!chatUsers[username]) {
                    chatUsers[username] = {
                        messageCount: 0,
                        firstSeen: new Date(),
                        badges: []
                    };
                }

                chatUsers[username].messageCount++;
                chatUsers[username].badges = badges;
                chatUsers[username].lastSeen = new Date();

                const bidPattern = /!(\d+)/;
                const match = message.match(bidPattern);

                if (match && match[1]) {
                    const bidAmount = parseInt(match[1]);
                    debugLog(`Puja detectada: ${bidAmount}`);
                    processBid(username, bidAmount, badges);
                } else {
                    debugLog(`No es una puja: ${message}`);
                }
            } catch (error) {
                debugLog(`Error parseando: ${error.message}`);
                console.error('Error parseando PRIVMSG:', error);
            }
        }

        function processBid(username, amount, badges) {
            debugLog(`Procesando puja: ${username} - ${amount}`);

            if (!currentAuction) {
                addLog(`@${username}: ${amount} ₧ - Sin subasta activa`, 'error');
                debugLog('No hay subasta activa');
                return;
            }

            if (restrictions.maxBid && amount > restrictions.maxBid) {
                addLog(`@${username}: ${amount} ₧ - Supera el máximo permitido (${restrictions.maxBid} ₧)`, 'error');
                debugLog(`Puja supera máximo: ${amount} > ${restrictions.maxBid}`);
                return;
            }

            const validationResult = validateBidder(username, badges);
            if (!validationResult.valid) {
                addLog(`@${username}: ${amount} ₧ - ${validationResult.reason}`, 'error');
                debugLog(`Validación fallida: ${validationResult.reason}`);
                return;
            }

            const currentHighest = currentAuction.currentBid || currentAuction.startingPrice;
            if (amount <= currentHighest) {
                addLog(`@${username}: ${amount} ₧ - Muy baja (actual: ${currentHighest} ₧)`, 'error');
                debugLog(`Puja muy baja: ${amount} <= ${currentHighest}`);
                return;
            }

            const bid = {
                username,
                amount,
                timestamp: new Date(),
                auctionId: currentAuction.id
            };

            if (!allBids[currentAuction.id]) allBids[currentAuction.id] = [];
            allBids[currentAuction.id].push(bid);

            // ACTUALIZAR ESTADÍSTICAS DEL USUARIO
            if (!userStats[username]) {
                userStats[username] = {
                    totalBids: 0,
                    totalSpent: 0,
                    auctionsWon: 0,
                    auctionsParticipated: 0,
                    highestBid: 0,
                    bidHistory: []
                };
            }

            userStats[username].totalBids++;
            userStats[username].bidHistory.push({
                amount,
                auctionTitle: currentAuction.title,
                timestamp: new Date()
            });

            if (amount > userStats[username].highestBid) {
                userStats[username].highestBid = amount;
            }

            // Marcar participación en esta subasta
            const participated = userStats[username].bidHistory.filter(b => b.auctionTitle === currentAuction.title).length;
            if (participated === 1) {
                userStats[username].auctionsParticipated++;
            }

            saveUserStats();

            currentAuction.currentBid = amount;
            currentAuction.currentWinner = username;
            currentAuction.bidCount = (currentAuction.bidCount || 0) + 1;

            document.getElementById('currentBidAmount').textContent = amount + ' ₧';
            document.getElementById('currentWinner').textContent = username;

            globalStats.totalBids++;
            globalStats.uniqueBidders.add(username);

            if (amount > globalStats.topBidderAmount) {
                globalStats.topBidder = username;
                globalStats.topBidderAmount = amount;
            }

            updateStats();
            addLog(`<span class="log-user">@${username}</span> pujó <strong>${amount} ₧</strong>`, 'bid');
            debugLog(`Puja aceptada: ${username} - ${amount}`);
        }

        function validateBidder(username, badges) {
            debugLog(`Validando usuario: ${username}`);

            if (restrictions.subscribersOnly) {
                const isSubscriber = badges.includes('subscriber') || badges.includes('founder') || badges.includes('broadcaster');
                if (!isSubscriber) {
                    return { valid: false, reason: 'Solo suscriptores pueden pujar' };
                }
            }

            if (restrictions.followersOnly) {
                const isTrustedUser = badges.includes('broadcaster') || badges.includes('moderator') || 
                                     badges.includes('subscriber') || badges.includes('founder') || badges.includes('vip');

                if (!isTrustedUser) {
                    if (chatUsers[username] && chatUsers[username].messageCount < 2) {
                        return { valid: false, reason: 'Solo seguidores del canal pueden pujar' };
                    } else if (!isTrustedUser && !chatUsers[username]) {
                        return { valid: false, reason: 'Solo seguidores del canal pueden pujar' };
                    }
                }
            }

            if (restrictions.minMessages) {
                const userMessages = chatUsers[username]?.messageCount || 0;
                if (userMessages < restrictions.minMessages) {
                    return { valid: false, reason: `Se requieren al menos ${restrictions.minMessages} mensajes (tienes ${userMessages})` };
                }
            }

            debugLog('Validación exitosa');
            return { valid: true };
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const btn = document.getElementById('connectBtn');

            if (connected) {
                indicator.classList.add('connected');
                text.textContent = `Conectado a ${DEFAULT_CHANNEL}`;
                if (btn) btn.textContent = 'Desconectar';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'Desconectado';
                if (btn) btn.textContent = 'Conectar';
            }
        }

        // Auction Control
        function startAuction(auction) {
            currentAuction = {
                ...auction,
                currentBid: null,
                currentWinner: null,
                bidCount: 0,
                startTime: Date.now(),
                endTime: Date.now() + AUCTION_DURATION
            };

            allBids[auction.id] = [];

            document.getElementById('activeAuctionTitle').textContent = auction.title;
            document.getElementById('currentBidAmount').textContent = auction.startingPrice + ' ₧';
            document.getElementById('currentWinner').textContent = 'Esperando pujas...';

            displayAuctionImages(auction.images);

            document.getElementById('activeAuctionCard').style.display = 'block';
            document.getElementById('noAuctionCard').style.display = 'none';

            startTimer();
            addLog(`📢 Nueva subasta iniciada: ${auction.title}`, 'system');
        }

        function displayAuctionImages(images) {
            const imagesContainer = document.getElementById('auctionImages');
            const mainImage = document.getElementById('mainImage');
            const thumbnailsContainer = document.getElementById('thumbnailsContainer');

            if (!images || images.length === 0) {
                imagesContainer.style.display = 'none';
                return;
            }

            imagesContainer.style.display = 'block';
            mainImage.src = images[0];

            thumbnailsContainer.innerHTML = '';
            images.forEach((imgSrc, index) => {
                const thumb = document.createElement('img');
                thumb.src = imgSrc;
                thumb.className = 'thumbnail' + (index === 0 ? ' active' : '');
                thumb.onclick = () => {
                    mainImage.src = imgSrc;
                    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                };
                thumbnailsContainer.appendChild(thumb);
            });
        }

        function endAuction() {
            if (!currentAuction) return;

            if (confirm('¿Finalizar la subasta actual?')) {
                handleAuctionEnd();
            }
        }

        function extendAuction() {
            if (currentAuction) {
                currentAuction.endTime += 60000;
                addLog('⏱️ Tiempo extendido: +1 minuto', 'system');
            }
        }

        function handleAuctionEnd() {
            if (!currentAuction) return;

            const bids = allBids[currentAuction.id] || [];
            const auction = {
                ...currentAuction,
                endTime: new Date(),
                finalBid: currentAuction.currentBid || currentAuction.startingPrice,
                winner: currentAuction.currentWinner,
                totalBids: bids.length,
                bids: bids,
                duration: Date.now() - currentAuction.startTime,
                uniqueBidders: new Set(bids.map(b => b.username)).size,
                bidHistory: bids,
                avgBid: bids.length > 0 ? Math.round(bids.reduce((sum, b) => sum + b.amount, 0) / bids.length) : 0,
                maxBid: bids.length > 0 ? Math.max(...bids.map(b => b.amount)) : currentAuction.startingPrice,
                minBid: bids.length > 0 ? Math.min(...bids.map(b => b.amount)) : currentAuction.startingPrice
            };

            // Actualizar stats del ganador
            if (auction.winner && userStats[auction.winner]) {
                userStats[auction.winner].auctionsWon++;
                userStats[auction.winner].totalSpent += auction.finalBid;
                saveUserStats();
                renderLeaderboards();
                renderUserStats();
            }

            auctionHistory.unshift(auction);
            saveAuctionHistory();

            globalStats.totalAuctions++;
            globalStats.totalPesetas += auction.finalBid;
            updateStats();

            if (auction.winner) {
                addLog(`🏆 Subasta finalizada. Ganador: <span class="log-user">@${auction.winner}</span> con <strong>${auction.finalBid} ₧</strong>`, 'winner');
            } else {
                addLog(`📢 Subasta finalizada sin pujas`, 'system');
            }

            currentAuction = null;
            stopTimer();
            showNoAuction();
            renderHistory();
        }

        function showNoAuction() {
            document.getElementById('activeAuctionCard').style.display = 'none';
            document.getElementById('noAuctionCard').style.display = 'block';
        }

        // Timer
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                if (!currentAuction) {
                    stopTimer();
                    return;
                }

                const remaining = Math.max(0, currentAuction.endTime - Date.now());
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);

                const timerEl = document.getElementById('auctionTimer');
                timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                if (remaining <= 30000) {
                    timerEl.classList.add('warning');
                } else {
                    timerEl.classList.remove('warning');
                }

                if (remaining === 0) {
                    handleAuctionEnd();
                }
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Activity Log - MODIFICADO PARA MOSTRAR LOS MÁS RECIENTES ARRIBA
        function addLog(message, type = 'system') {
            const logContainer = document.getElementById('activityLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;

            const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;

            // Insertar al PRINCIPIO del contenedor
            if (logContainer.firstChild) {
                logContainer.insertBefore(entry, logContainer.firstChild);
            } else {
                logContainer.appendChild(entry);
            }

            // Limitar a 100 entradas
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function clearLog() {
            const logContainer = document.getElementById('activityLog');
            logContainer.innerHTML = '<div class="log-entry system"><span class="log-time">[--:--]</span> Log limpiado</div>';
        }

        // Stats
        function updateStats() {
            document.getElementById('totalAuctions').textContent = globalStats.totalAuctions;
            document.getElementById('totalBids').textContent = globalStats.totalBids;
            document.getElementById('totalPesetas').textContent = globalStats.totalPesetas + ' ₧';
            document.getElementById('uniqueBidders').textContent = globalStats.uniqueBidders.size;
            document.getElementById('topBidder').textContent = globalStats.topBidder || '-';

            const avgBid = globalStats.totalBids > 0 ? Math.round(globalStats.totalPesetas / globalStats.totalBids) : 0;
            document.getElementById('avgBid').textContent = avgBid;
        }

        // Leaderboards
        function renderLeaderboards() {
            const users = Object.entries(userStats);

            if (users.length === 0) {
                document.getElementById('emptyLeaderboards').style.display = 'block';
                return;
            }

            document.getElementById('emptyLeaderboards').style.display = 'none';

            // Más pujas ganadas
            const winsLeaderboard = users
                .sort((a, b) => b[1].auctionsWon - a[1].auctionsWon)
                .slice(0, 10);

            renderLeaderboardTable('winsLeaderboard', winsLeaderboard, 'auctionsWon');

            // Más pesetas gastadas
            const spentLeaderboard = users
                .sort((a, b) => b[1].totalSpent - a[1].totalSpent)
                .slice(0, 10);

            renderLeaderboardTable('spentLeaderboard', spentLeaderboard, 'totalSpent', true);

            // Más pujas participadas
            const participationLeaderboard = users
                .sort((a, b) => b[1].auctionsParticipated - a[1].auctionsParticipated)
                .slice(0, 10);

            renderLeaderboardTable('participationLeaderboard', participationLeaderboard, 'auctionsParticipated');
        }

        function renderLeaderboardTable(tableId, data, statKey, isPesetas = false) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';

            data.forEach(([username, stats], index) => {
                const row = document.createElement('tr');
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';

                row.innerHTML = `
                    <td class="leaderboard-rank ${rankClass}">${index + 1}</td>
                    <td class="leaderboard-username">${username}</td>
                    <td class="leaderboard-value">${stats[statKey]}${isPesetas ? ' ₧' : ''}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // User Stats
        function renderUserStats() {
            const container = document.getElementById('userStatsList');
            const emptyState = document.getElementById('emptyUsers');

            const users = Object.entries(userStats).sort((a, b) => b[1].totalBids - a[1].totalBids);

            if (users.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = users.map(([username, stats]) => `
                <div class="user-stats-card" onclick="showUserDetails('${username}')">
                    <div class="user-stats-header">
                        <span class="user-stats-name">@${username}</span>
                        <span class="user-stats-badge">${stats.auctionsWon} ganadas</span>
                    </div>
                    <div class="user-stats-grid">
                        <div class="history-detail">
                            <span class="detail-label">Total Pujas</span>
                            <span class="detail-value">${stats.totalBids}</span>
                        </div>
                        <div class="history-detail">
                            <span class="detail-label">Gastado</span>
                            <span class="detail-value">${stats.totalSpent} ₧</span>
                        </div>
                        <div class="history-detail">
                            <span class="detail-label">Participadas</span>
                            <span class="detail-value">${stats.auctionsParticipated}</span>
                        </div>
                        <div class="history-detail">
                            <span class="detail-label">Puja Máxima</span>
                            <span class="detail-value">${stats.highestBid} ₧</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showUserDetails(username) {
            const stats = userStats[username];
            if (!stats) return;

            document.getElementById('userDetailsTitle').textContent = `@${username} - Detalles`;

            const recentBids = stats.bidHistory.slice(-10).reverse();

            const detailsHTML = `
                <div class="user-stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="history-detail">
                        <span class="detail-label">Total Pujas</span>
                        <span class="detail-value">${stats.totalBids}</span>
                    </div>
                    <div class="history-detail">
                        <span class="detail-label">Subastas Ganadas</span>
                        <span class="detail-value">${stats.auctionsWon}</span>
                    </div>
                    <div class="history-detail">
                        <span class="detail-label">Total Gastado</span>
                        <span class="detail-value">${stats.totalSpent} ₧</span>
                    </div>
                    <div class="history-detail">
                        <span class="detail-label">Participadas</span>
                        <span class="detail-value">${stats.auctionsParticipated}</span>
                    </div>
                    <div class="history-detail">
                        <span class="detail-label">Puja Máxima</span>
                        <span class="detail-value">${stats.highestBid} ₧</span>
                    </div>
                    <div class="history-detail">
                        <span class="detail-label">Puja Media</span>
                        <span class="detail-value">${stats.totalBids > 0 ? Math.round(stats.totalSpent / stats.totalBids) : 0} ₧</span>
                    </div>
                </div>

                <h4 style="margin-bottom: 1rem; color: var(--text);">Historial Reciente (últimas 10 pujas)</h4>
                ${recentBids.map(bid => `
                    <div class="history-item" style="margin-bottom: 0.5rem; padding: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.875rem; color: var(--text-muted);">${bid.auctionTitle}</span>
                            <span style="font-weight: 700; color: var(--primary);">${bid.amount} ₧</span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                            ${new Date(bid.timestamp).toLocaleString('es-ES')}
                        </div>
                    </div>
                `).join('')}
            `;

            document.getElementById('userDetailsBody').innerHTML = detailsHTML;
            document.getElementById('userDetailsModal').classList.add('active');
        }

        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.remove('active');
        }

        // Modal
        function openNewAuctionModal() {
            document.getElementById('newAuctionModal').classList.add('active');
        }

        function closeNewAuctionModal() {
            document.getElementById('newAuctionModal').classList.remove('active');
            document.getElementById('newAuctionForm').reset();
            document.getElementById('imagePreviewGrid').innerHTML = '';
        }

        function previewImages() {
            const input = document.getElementById('auctionImagesInput');
            const grid = document.getElementById('imagePreviewGrid');
            grid.innerHTML = '';

            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'image-preview';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="image-remove" onclick="removeImage(${i})">×</button>
                    `;
                    grid.appendChild(preview);
                };

                reader.readAsDataURL(file);
            }
        }

        function removeImage(index) {
            const input = document.getElementById('auctionImagesInput');
            const dt = new DataTransfer();

            for (let i = 0; i < input.files.length; i++) {
                if (i !== index) {
                    dt.items.add(input.files[i]);
                }
            }

            input.files = dt.files;
            previewImages();
        }

        function saveNewAuction() {
            const input = document.getElementById('auctionImagesInput');
            const images = [];

            const previews = document.querySelectorAll('#imagePreviewGrid img');
            previews.forEach(img => {
                images.push(img.src);
            });

            const auction = {
                id: Date.now(),
                title: document.getElementById('auctionTitle').value,
                description: document.getElementById('auctionDescription').value,
                startingPrice: parseInt(document.getElementById('startingPrice').value),
                images: images,
                createdAt: new Date()
            };

            configuredAuctions.push(auction);
            saveConfiguredAuctions();
            renderConfiguredAuctions();
            closeNewAuctionModal();

            addLog(`✅ Subasta "${auction.title}" guardada`, 'system');
            switchTab({ target: document.querySelectorAll('.tab')[1] }, 'configured');
        }

        // Configured Auctions
        function renderConfiguredAuctions() {
            const container = document.getElementById('configuredAuctionsList');
            const emptyState = document.getElementById('emptyConfigured');

            if (configuredAuctions.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = configuredAuctions.map(auction => `
                <div class="auction-card">
                    <div class="auction-info">
                        <h4>${auction.title}</h4>
                        <p>Precio inicial: ${auction.startingPrice} ₧</p>
                    </div>
                    <div class="auction-card-actions">
                        <button class="btn btn-primary btn-sm" onclick='startAuction(${JSON.stringify(auction)})'>Iniciar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteConfiguredAuction(${auction.id})">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteConfiguredAuction(id) {
            if (confirm('¿Eliminar esta subasta?')) {
                configuredAuctions = configuredAuctions.filter(a => a.id !== id);
                saveConfiguredAuctions();
                renderConfiguredAuctions();
            }
        }

        // History
        function renderHistory() {
            const container = document.getElementById('historyList');
            const emptyState = document.getElementById('emptyHistory');

            if (auctionHistory.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = auctionHistory.map(auction => {
                const duration = auction.duration ? formatDuration(auction.duration) : 'N/A';

                return `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-title">${auction.title}</span>
                            <span class="history-amount">${auction.finalBid} ₧</span>
                        </div>
                        <div class="history-winner">
                            ${auction.winner ? `<strong>@${auction.winner}</strong>` : 'Sin pujas'}
                        </div>
                        <div class="history-details">
                            <div class="history-detail">
                                <span class="detail-label">Total Pujas</span>
                                <span class="detail-value">${auction.totalBids || 0}</span>
                            </div>
                            <div class="history-detail">
                                <span class="detail-label">Pujadores Únicos</span>
                                <span class="detail-value">${auction.uniqueBidders || 0}</span>
                            </div>
                            <div class="history-detail">
                                <span class="detail-label">Puja Media</span>
                                <span class="detail-value">${auction.avgBid || 0} ₧</span>
                            </div>
                            <div class="history-detail">
                                <span class="detail-label">Puja Máxima</span>
                                <span class="detail-value">${auction.maxBid || auction.startingPrice} ₧</span>
                            </div>
                            <div class="history-detail">
                                <span class="detail-label">Puja Mínima</span>
                                <span class="detail-value">${auction.minBid || auction.startingPrice} ₧</span>
                            </div>
                            <div class="history-detail">
                                <span class="detail-label">Duración</span>
                                <span class="detail-value">${duration}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}m ${seconds}s`;
        }

        // Tabs
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Debug
        function toggleDebugPanel() {
            document.getElementById('debugPanel').classList.toggle('active');
        }

        function debugLog(message) {
            const debugContent = document.getElementById('debugContent');
            const entry = document.createElement('div');
            entry.className = 'debug-entry';
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            debugContent.insertBefore(entry, debugContent.firstChild);

            while (debugContent.children.length > 50) {
                debugContent.removeChild(debugContent.lastChild);
            }
        }

        // Export
        function exportStats() {
            const data = {
                stats: {
                    ...globalStats,
                    uniqueBidders: Array.from(globalStats.uniqueBidders)
                },
                userStats: userStats,
                history: auctionHistory,
                exportDate: new Date()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stats_${Date.now()}.json`;
            a.click();

            addLog('📊 Estadísticas exportadas', 'system');
        }

        // Local Storage
        function loadConfiguration() {
            const config = JSON.parse(localStorage.getItem('auctionConfig') || '{}');
            restrictions.followersOnly = config.followersOnly || false;
            restrictions.subscribersOnly = config.subscribersOnly || false;
            restrictions.minMessages = config.minMessages || 0;
            restrictions.maxBid = config.maxBid || 0;

            document.getElementById('followersOnly').checked = restrictions.followersOnly;
            document.getElementById('subscribersOnly').checked = restrictions.subscribersOnly;
            document.getElementById('minMessages').value = restrictions.minMessages;
            document.getElementById('maxBid').value = restrictions.maxBid;
        }

        function saveConfiguration() {
            restrictions.followersOnly = document.getElementById('followersOnly').checked;
            restrictions.subscribersOnly = document.getElementById('subscribersOnly').checked;
            restrictions.minMessages = parseInt(document.getElementById('minMessages').value) || 0;
            restrictions.maxBid = parseInt(document.getElementById('maxBid').value) || 0;

            localStorage.setItem('auctionConfig', JSON.stringify(restrictions));
        }

        function loadConfiguredAuctions() {
            const data = localStorage.getItem('configuredAuctions');
            if (data) {
                configuredAuctions = JSON.parse(data);
                renderConfiguredAuctions();
            }
        }

        function saveConfiguredAuctions() {
            localStorage.setItem('configuredAuctions', JSON.stringify(configuredAuctions));
        }

        function loadAuctionHistory() {
            const data = localStorage.getItem('auctionHistory');
            if (data) {
                auctionHistory = JSON.parse(data);

                auctionHistory.forEach(auction => {
                    globalStats.totalAuctions++;
                    globalStats.totalPesetas += auction.finalBid;
                    globalStats.totalBids += auction.totalBids || 0;

                    if (auction.bids) {
                        auction.bids.forEach(bid => {
                            globalStats.uniqueBidders.add(bid.username);
                            if (bid.amount > globalStats.topBidderAmount) {
                                globalStats.topBidder = bid.username;
                                globalStats.topBidderAmount = bid.amount;
                            }
                        });
                    }
                });

                renderHistory();
                updateStats();
            }
        }

        function saveAuctionHistory() {
            localStorage.setItem('auctionHistory', JSON.stringify(auctionHistory));
        }

        function loadUserStats() {
            const data = localStorage.getItem('userStats');
            if (data) {
                userStats = JSON.parse(data);
            }
        }

        function saveUserStats() {
            localStorage.setItem('userStats', JSON.stringify(userStats));
        }

        // Auto-save config on change
        document.getElementById('followersOnly').addEventListener('change', saveConfiguration);
        document.getElementById('subscribersOnly').addEventListener('change', saveConfiguration);
        document.getElementById('minMessages').addEventListener('change', saveConfiguration);
        document.getElementById('maxBid').addEventListener('change', saveConfiguration);
    </script>
</body>
</html>